<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/polyfill/lib/mutationobserver.js - Itsa</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Itsa"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/BaseClass.html">BaseClass</a></li>
            
                <li><a href="../classes/Classes.html">Classes</a></li>
            
                <li><a href="../classes/DD.html">DD</a></li>
            
                <li><a href="../classes/document.html">document</a></li>
            
                <li><a href="../classes/Element.html">Element</a></li>
            
                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/Event.Emitter.html">Event.Emitter</a></li>
            
                <li><a href="../classes/Event.Listener.html">Event.Listener</a></li>
            
                <li><a href="../classes/FocusManager.html">FocusManager</a></li>
            
                <li><a href="../classes/Function.html">Function</a></li>
            
                <li><a href="../classes/IO.html">IO</a></li>
            
                <li><a href="../classes/ITSA.html">ITSA</a></li>
            
                <li><a href="../classes/Node.html">Node</a></li>
            
                <li><a href="../classes/NS-vdom.html">NS-vdom</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/Plugins.html">Plugins</a></li>
            
                <li><a href="../classes/Promise.html">Promise</a></li>
            
                <li><a href="../classes/String.html">String</a></li>
            
                <li><a href="../classes/USERAGENT.html">USERAGENT</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
                <li><a href="../classes/vnode.html">vnode</a></li>
            
                <li><a href="../classes/window.html">window</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/attribute-extractor.html">attribute-extractor</a></li>
            
                <li><a href="../modules/drag.html">drag</a></li>
            
                <li><a href="../modules/drag-drop.html">drag-drop</a></li>
            
                <li><a href="../modules/element-array.html">element-array</a></li>
            
                <li><a href="../modules/element-plugin.html">element-plugin</a></li>
            
                <li><a href="../modules/event.html">event</a></li>
            
                <li><a href="../modules/event-blurnode.html">event-blurnode</a></li>
            
                <li><a href="../modules/event-dom.html">event-dom</a></li>
            
                <li><a href="../modules/event-emitter.html">event-emitter</a></li>
            
                <li><a href="../modules/event-focusnode.html">event-focusnode</a></li>
            
                <li><a href="../modules/event-hover.html">event-hover</a></li>
            
                <li><a href="../modules/event-listener.html">event-listener</a></li>
            
                <li><a href="../modules/event-mobile.html">event-mobile</a></li>
            
                <li><a href="../modules/event-objectobserve.html">event-objectobserve</a></li>
            
                <li><a href="../modules/extend-document.html">extend-document</a></li>
            
                <li><a href="../modules/extend-element.html">extend-element</a></li>
            
                <li><a href="../modules/extra_classes.js.html">extra/classes.js</a></li>
            
                <li><a href="../modules/focusmanager.html">focusmanager</a></li>
            
                <li><a href="../modules/html-parser.html">html-parser</a></li>
            
                <li><a href="../modules/io.html">io</a></li>
            
                <li><a href="../modules/io-assets.html">io-assets</a></li>
            
                <li><a href="../modules/io-cors.html">io-cors</a></li>
            
                <li><a href="../modules/io-jsonp.html">io-jsonp</a></li>
            
                <li><a href="../modules/io-transfer.html">io-transfer</a></li>
            
                <li><a href="../modules/io-xml.html">io-xml</a></li>
            
                <li><a href="../modules/itsa.build.html">itsa.build</a></li>
            
                <li><a href="../modules/js-ext.html">js-ext</a></li>
            
                <li><a href="../modules/lib_array.js.html">lib/array.js</a></li>
            
                <li><a href="../modules/lib_function.js.html">lib/function.js</a></li>
            
                <li><a href="../modules/lib_object.js.html">lib/object.js</a></li>
            
                <li><a href="../modules/lib_promise.s.html">lib/promise.s</a></li>
            
                <li><a href="../modules/lib_string.js.html">lib/string.js</a></li>
            
                <li><a href="../modules/node-parser.html">node-parser</a></li>
            
                <li><a href="../modules/node-win.html">node-win</a></li>
            
                <li><a href="../modules/useragent.html">useragent</a></li>
            
                <li><a href="../modules/utils.html">utils</a></li>
            
                <li><a href="../modules/vdom.html">vdom</a></li>
            
                <li><a href="../modules/vdom-ns.html">vdom-ns</a></li>
            
                <li><a href="../modules/vnode.html">vnode</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/polyfill/lib/mutationobserver.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Copyright 2012 The Polymer Authors. All rights reserved.
 * Use of this source code is goverened by a BSD-style
 * license that can be found in the LICENSE file.
 */

(function(global) {
  &quot;use strict&quot;;

  var registrationsTable = new global.WeakMap(),
      uidCounter = 0,
      currentRecord, recordWithOldValue,
      setImmediate, setImmediateQueue, sentinel, queue, isScheduled, scheduledObservers;

  // As much as we would like to use the native implementation, IE
  // (all versions) suffers a rather annoying bug where it will drop or defer
  // callbacks when heavy DOM operations are being performed concurrently.
  //
  // For a thorough discussion on this, see:
  // http://codeforhire.com/2013/09/21/setimmediate-and-messagechannel-broken-on-internet-explorer-10/
  if (/Trident/.test(global.navigator.userAgent)) {
      // Sadly, this bug also affects postMessage and MessageQueues.
      //
      // We would like to use the onreadystatechange hack for IE &lt;= 10, but it is
      // dangerous in the polyfilled environment due to requiring that the
      // observed script element be in the document.
      setImmediate = setTimeout;

  // If some other browser ever implements it, let&#x27;s prefer their native
  // implementation:
  } else if (global.setImmediate) {
      setImmediate = global.setImmediate;
  } else {
      // Otherwise, we fall back to postMessage as a means of emulating the next
      // task semantics of setImmediate.
      setImmediateQueue = [];
      sentinel = String(Math.random());
      global.addEventListener(&#x27;message&#x27;, function(e) {
          if (e.data === sentinel) {
              queue = setImmediateQueue;
              setImmediateQueue = [];
              queue.forEach(function(func) {
                 func();
              });
          }
      });
      setImmediate = function(func) {
          setImmediateQueue.push(func);
          global.postMessage(sentinel, &#x27;*&#x27;);
      };
  }

  // This is used to ensure that we never schedule 2 callas to setImmediate
  isScheduled = false;

  // Keep track of observers that needs to be notified next time.
  scheduledObservers = [];

  /**
   * Schedules |dispatchCallback| to be called in the future.
   * @param {MutationObserver} observer
   */
  function scheduleCallback(observer) {
      scheduledObservers.push(observer);
      if (!isScheduled) {
          isScheduled = true;
          setImmediate(dispatchCallbacks);
      }
  }

  function wrapIfNeeded(node) {
      return (global.ShadowDOMPolyfill &amp;&amp; global.ShadowDOMPolyfill.wrapIfNeeded(node)) || node;
  }

  function dispatchCallbacks() {
      // http://dom.spec.whatwg.org/#mutation-observers

      var observers = scheduledObservers,
          anyNonEmpty = false;

      isScheduled = false; // Used to allow a new setImmediate call above.

      scheduledObservers = [];
      // Sort observers based on their creation UID (incremental).
      observers.sort(function(o1, o2) {
          return o1.uid_ - o2.uid_;
      });

      observers.forEach(function(observer) {
          // 2.1, 2.2
          var queue = observer.takeRecords();
          // 2.3. Remove all transient registered observers whose observer is mo.
          removeTransientObserversFor(observer);

          // 2.4
          if (queue.length) {
              observer.callback_(queue, observer);
              anyNonEmpty = true;
          }
      });

      // 3.
      if (anyNonEmpty) {
          dispatchCallbacks();
      }
  }

  function removeTransientObserversFor(observer) {
      observer.nodes_.forEach(function(node) {
          var registrations = registrationsTable.get(node);
          if (!registrations) {
              return;
          }
          registrations.forEach(function(registration) {
              if (registration.observer === observer) {
                  registration.removeTransientObservers();
              }
          });
      });
  }

  /**
   * This function is used for the &quot;For each registered observer observer (with
   * observer&#x27;s options as options) in target&#x27;s list of registered observers,
   * run these substeps:&quot; and the &quot;For each ancestor ancestor of target, and for
   * each registered observer observer (with options options) in ancestor&#x27;s list
   * of registered observers, run these substeps:&quot; part of the algorithms. The
   * |options.subtree| is checked to ensure that the callback is called
   * correctly.
   *
   * @param {Node} target
   * @param {function(MutationObserverInit):MutationRecord} callback
   */
  function forEachAncestorAndObserverEnqueueRecord(target, callback) {
      var node, registration, registrations, j, options, record;
      for (node = target; node; node = node.parentNode) {
          registrations = registrationsTable.get(node);

          if (registrations) {
              for (j = 0; j &lt; registrations.length; j++) {
                  registration = registrations[j];
                  options = registration.options;

                  // Only target ignores subtree.
                  if ((node !== target) &amp;&amp; !options.subtree) {
                      continue;
                  }

                  record = callback(options);
                  if (record) {
                      registration.enqueue(record);
                  }
              }
          }
        }
  }

  /**
   * The class that maps to the DOM MutationObserver interface.
   * @param {Function} callback.
   * @constructor
   */
  function JsMutationObserver(callback) {
      var instance = this;
      instance.callback_ = callback;
      instance.nodes_ = [];
      instance.records_ = [];
      instance.uid_ = ++uidCounter;
  }

  JsMutationObserver.prototype = {
      observe: function(target, options) {
          var registrations, registration, i;
          target = wrapIfNeeded(target);

          if (
              // 1.1
              (!options.childList &amp;&amp; !options.attributes &amp;&amp; !options.characterData) ||

              // 1.2
              (options.attributeOldValue &amp;&amp; !options.attributes) ||

              // 1.3
              (options.attributeFilter &amp;&amp; options.attributeFilter.length &amp;&amp; !options.attributes) ||

              // 1.4
              (options.characterDataOldValue &amp;&amp; !options.characterData)) {

              throw new SyntaxError();
          }

          registrations = registrationsTable.get(target);
          if (!registrations) {
              registrationsTable.set(target, registrations = []);
          }

          // 2
          // If target&#x27;s list of registered observers already includes a registered
          // observer associated with the context object, replace that registered
          // observer&#x27;s options with options.
          for (i = 0; i &lt; registrations.length; i++) {
              if (registrations[i].observer === this) {
                  registration = registrations[i];
                  registration.removeListeners();
                  registration.options = options;
                  break;
              }
          }

          // 3.
          // Otherwise, add a new registered observer to target&#x27;s list of registered
          // observers with the context object as the observer and options as the
          // options, and add target to context object&#x27;s list of nodes on which it
          // is registered.
          if (!registration) {
              registration = new Registration(this, target, options);
              registrations.push(registration);
              this.nodes_.push(target);
          }

          registration.addListeners();
      },

      disconnect: function() {
          var instance = this,
              len = instance.nodes_.length,
              i, k, node, registrations, registration;
          for (k=0; k&lt;len; k++) {
              node = instance.nodes_[k];
              registrations = registrationsTable.get(node);
              for (i = 0; i &lt; registrations.length; i++) {
                  registration = registrations[i];
                  if (registration.observer === instance) {
                      registration.removeListeners();
                      registrations.splice(i, 1);
                      // Each node can only have one registered observer associated with
                      // this observer.
                      break;
                  }
              }
          }
          instance.records_ = [];
      },

      takeRecords: function() {
          var copyOfRecords = this.records_;
          this.records_ = [];
          return copyOfRecords;
      }
  };

  /**
   * @param {string} type
   * @param {Node} target
   * @constructor
   */
  function MutationRecord(type, target) {
      var instance = this;
      instance.type = type;
      instance.target = target;
      instance.addedNodes = [];
      instance.removedNodes = [];
      instance.previousSibling = null;
      instance.nextSibling = null;
      instance.attributeName = null;
      instance.attributeNamespace = null;
      instance.oldValue = null;
  }

  function copyMutationRecord(original) {
      var record = new MutationRecord(original.type, original.target);
      record.addedNodes = original.addedNodes.slice();
      record.removedNodes = original.removedNodes.slice();
      record.previousSibling = original.previousSibling;
      record.nextSibling = original.nextSibling;
      record.attributeName = original.attributeName;
      record.attributeNamespace = original.attributeNamespace;
      record.oldValue = original.oldValue;
      return record;
  }

  // We keep track of the two (possibly one) records used in a single mutation.

  /**
   * Creates a record without |oldValue| and caches it as |currentRecord| for
   * later use.
   * @param {string} oldValue
   * @return {MutationRecord}
   */
  function getRecord(type, target) {
      currentRecord = new MutationRecord(type, target);
      return currentRecord;
  }

  /**
   * Gets or creates a record with |oldValue| based in the |currentRecord|
   * @param {string} oldValue
   * @return {MutationRecord}
   */
  function getRecordWithOldValue(oldValue) {
      if (recordWithOldValue) {
          return recordWithOldValue;
      }
      recordWithOldValue = copyMutationRecord(currentRecord);
      recordWithOldValue.oldValue = oldValue;
      return recordWithOldValue;
  }

  function clearRecords() {
      currentRecord = recordWithOldValue = undefined;
  }

  /**
   * @param {MutationRecord} record
   * @return {boolean} Whether the record represents a record from the current
   * mutation event.
   */
  function recordRepresentsCurrentMutation(record) {
      return (record === recordWithOldValue) || (record === currentRecord);
  }

  /**
   * Selects which record, if any, to replace the last record in the queue.
   * This returns |null| if no record should be replaced.
   *
   * @param {MutationRecord} lastRecord
   * @param {MutationRecord} newRecord
   * @param {MutationRecord}
   */
  function selectRecord(lastRecord, newRecord) {
      if (lastRecord === newRecord) {
          return lastRecord;
      }

      // Check if the the record we are adding represents the same record. If
      // so, we keep the one with the oldValue in it.
      if (recordWithOldValue &amp;&amp; recordRepresentsCurrentMutation(lastRecord)) {
          return recordWithOldValue;
      }

      return null;
  }

  /**
   * Class used to represent a registered observer.
   * @param {MutationObserver} observer
   * @param {Node} target
   * @param {MutationObserverInit} options
   * @constructor
   */
  function Registration(observer, target, options) {
      var instance = this;
      instance.observer = observer;
      instance.target = target;
      instance.options = options;
      instance.transientObservedNodes = [];
  }

  Registration.prototype = {
      enqueue: function(record) {
          var records = this.observer.records_,
              length = records.length,
              lastRecord, recordToReplaceLast;

          // There are cases where we replace the last record with the new record.
          // For example if the record represents the same mutation we need to use
          // the one with the oldValue. If we get same record (this can happen as we
          // walk up the tree) we ignore the new record.
          if (records.length &gt; 0) {
              lastRecord = records[length - 1];
              recordToReplaceLast = selectRecord(lastRecord, record);
              if (recordToReplaceLast) {
                  records[length - 1] = recordToReplaceLast;
                  return;
              }
          } else {
              scheduleCallback(this.observer);
          }

          records[length] = record;
      },

      changeListeners_: function(node, remove) {
          var instance = this,
              options = instance.options;
          if (options.attributes) {
              remove ? node.removeEventListener(&#x27;DOMAttrModified&#x27;, instance, true) : node.addEventListener(&#x27;DOMAttrModified&#x27;, instance, true);
          }

          if (options.characterData) {
              remove ? node.removeEventListener(&#x27;DOMCharacterDataModified&#x27;, instance, true) : node.addEventListener(&#x27;DOMCharacterDataModified&#x27;, instance, true);
          }

          if (options.childList) {
              remove ? node.removeEventListener(&#x27;DOMNodeInserted&#x27;, instance, true) : node.addEventListener(&#x27;DOMNodeInserted&#x27;, instance, true);
          }

          if (options.childList || options.subtree) {
              remove ? node.removeEventListener(&#x27;DOMNodeRemoved&#x27;, instance, true) : node.addEventListener(&#x27;DOMNodeRemoved&#x27;, instance, true);
          }
      },

      addListeners: function() {
          this.changeListeners_(this.target);
      },

      removeListeners: function() {
          this.changeListeners_(this.target, true);
      },

      /**
       * Adds a transient observer on node. The transient observer gets removed
       * next time we deliver the change records.
       * @param {Node} node
       */
      addTransientObserver: function(node) {
          var instance = this,
              registrations;
          // Don&#x27;t add transient observers on the target itself. We already have all
          // the required listeners set up on the target.
          if (node === instance.target) {
              return;
          }

          instance.changeListeners_(node);
          instance.transientObservedNodes.push(node);
          registrations = registrationsTable.get(node);
          if (!registrations) {
              registrationsTable.set(node, registrations = []);
          }

          // We know that registrations does not contain this because we already
          // checked if node === this.target.
          registrations.push(instance);
      },

      removeTransientObservers: function() {
          var instance = this,
              transientObservedNodes = instance.transientObservedNodes,
              len = transientObservedNodes.length,
              registrations, i, k, node;
          instance.transientObservedNodes = [];

          for (k=0; k&lt;len; k++) {
              node = transientObservedNodes[k];
              // Transient observers are never added to the target.
              instance.changeListeners_(node, true);

              registrations = registrationsTable.get(node);
              for (i = 0; i &lt; registrations.length; i++) {
                  if (registrations[i] === instance) {
                      registrations.splice(i, 1);
                      // Each node can only have one registered observer associated with
                      // this observer.
                      break;
                  }
              }
          }
      },

      handleEvent: function(e) {
          var name, namespace, target, record, changedNode, addedNodes, removedNodes, previousSibling, nextSibling, oldValue;
          // Stop propagation since we are managing the propagation manually.
          // This means that other mutation events on the page will not work
          // correctly but that is by design.
          e.stopImmediatePropagation();

          switch (e.type) {
              case &#x27;DOMAttrModified&#x27;:
                  // http://dom.spec.whatwg.org/#concept-mo-queue-attributes

                  name = e.attrName;
                  namespace = e.relatedNode.namespaceURI;
                  target = e.target;

                  // 1.
                  record = getRecord(&#x27;attributes&#x27;, target);
                  record.attributeName = name;
                  record.attributeNamespace = namespace;

                  // 2.
                  oldValue = (e.attrChange === global.MutationEvent.ADDITION) ? null : e.prevValue;

                  forEachAncestorAndObserverEnqueueRecord(target, function(options) {
                      // 3.1, 4.2
                      if (!options.attributes) {
                          return;
                      }

                      // 3.2, 4.3
                      if (options.attributeFilter &amp;&amp; options.attributeFilter.length &amp;&amp;
                          (options.attributeFilter.indexOf(name) === -1) &amp;&amp;
                          (options.attributeFilter.indexOf(namespace) === -1)) {
                          return;
                      }
                      // 3.3, 4.4
                      if (options.attributeOldValue) {
                          return getRecordWithOldValue(oldValue);
                      }

                      // 3.4, 4.5
                      return record;
                  });

                  break;

              case &#x27;DOMCharacterDataModified&#x27;:
                  // http://dom.spec.whatwg.org/#concept-mo-queue-characterdata
                  target = e.target;

                  // 1.
                  record = getRecord(&#x27;characterData&#x27;, target);

                  // 2.
                  oldValue = e.prevValue;

                  forEachAncestorAndObserverEnqueueRecord(target, function(options) {
                      // 3.1, 4.2
                      if (!options.characterData) {
                          return;
                      }

                      // 3.2, 4.3
                      if (options.characterDataOldValue) {
                          return getRecordWithOldValue(oldValue);
                      }

                      // 3.3, 4.4
                      return record;
                  });

                  break;

              case &#x27;DOMNodeRemoved&#x27;:
                  this.addTransientObserver(e.target);
                  // Fall through.
                  /* falls through */
              case &#x27;DOMNodeInserted&#x27;:
                  // http://dom.spec.whatwg.org/#concept-mo-queue-childlist
                  target = e.relatedNode;
                  changedNode = e.target;
                  if (e.type === &#x27;DOMNodeInserted&#x27;) {
                      addedNodes = [changedNode];
                      removedNodes = [];
                  } else {

                      addedNodes = [];
                      removedNodes = [changedNode];
                  }
                  previousSibling = changedNode.previousSibling;
                  nextSibling = changedNode.nextSibling;

                  // 1.
                  record = getRecord(&#x27;childList&#x27;, target);
                  record.addedNodes = addedNodes;
                  record.removedNodes = removedNodes;
                  record.previousSibling = previousSibling;
                  record.nextSibling = nextSibling;

                  forEachAncestorAndObserverEnqueueRecord(target, function(options) {
                      // 2.1, 3.2
                      if (!options.childList) {
                         return;
                      }

                      // 2.2, 3.3
                      return record;
                  });

          }

          clearRecords();
      }
  };

  global.JsMutationObserver = JsMutationObserver;

  if (!global.MutationObserver) {
      global.MutationObserver = JsMutationObserver;
  }


}(typeof global !== &#x27;undefined&#x27; ? global : /* istanbul ignore next */ this));
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
